#!/bin/bash
#----------------------------------------------------------------------------------------------------------------------------------------------------------
# Description: This script finds and removes orphaned snap packages (not default providers or bases) and disabled snaps.
# Adds undo functionality to list and reinstall snaps removed in the last run.
# License: MIT. Copyright (c) 2024 Mario Herrmann.
#----------------------------------------------------------------------------------------------------------------------------------------------------------

set -euo pipefail

SCRIPT_NAME="orphand_snaps"
INSTALL_PATH="/usr/local/bin/${SCRIPT_NAME}"
SERVICE_NAME="orphand-snaps.service"
TIMER_NAME="orphand-snaps.timer"
SYSTEMD_DIR="/etc/systemd/system"

# Use /usr/share/man for broader MANPATH compatibility
MAN_DST_DIR="/usr/share/man/man8"
MAN_PAGE_RAW="${MAN_DST_DIR}/orphand_snaps.8"
MAN_PAGE_GZ="${MAN_DST_DIR}/orphand_snaps.8.gz"

# State file to record last removed snaps
STATE_DIR="/var/lib/${SCRIPT_NAME}"
STATE_FILE="${STATE_DIR}/last_removed.txt"

# Pick sudo or doas. Override with OVERRIDE_ELEVATION=sudo|doas
choose_elev() {
  if [ "${OVERRIDE_ELEVATION:-}" = "sudo" ]; then
    echo "sudo"; return
  elif [ "${OVERRIDE_ELEVATION:-}" = "doas" ]; then
    echo "doas"; return
  fi
  if command -v doas >/dev/null 2>&1; then
    echo "doas"
  elif command -v sudo >/dev/null 2>&1; then
    echo "sudo"
  else
    echo "Error: Neither sudo nor doas found in PATH." >&2
    exit 1
  fi
}

# Choose elevation on demand (OVERRIDE_ELEVATION can change at runtime)
get_elev() { choose_elev; }

# Ensure state directory and file exist
ensure_state() {
  local ELEV; ELEV="$(get_elev)"
  "$ELEV" install -d -m 0755 "${STATE_DIR}"
  "$ELEV" touch "${STATE_FILE}"
}

install_units() {
  local ELEV; ELEV="$(get_elev)"
  echo "Installing ${SCRIPT_NAME} to ${INSTALL_PATH}..."
  "$ELEV" install -m 0755 "$0" "$INSTALL_PATH"

  echo "Preparing state directory..."
  ensure_state

  echo "Creating systemd service and timer..."
  "$ELEV" tee "${SYSTEMD_DIR}/${SERVICE_NAME}" >/dev/null <<'SERVICE'
[Unit]
Description=Remove orphaned and disabled snaps

[Service]
Type=oneshot
ExecStart=/usr/local/bin/orphand_snaps
Nice=10
IOSchedulingClass=best-effort
IOSchedulingPriority=7

[Install]
WantedBy=multi-user.target
SERVICE

  "$ELEV" tee "${SYSTEMD_DIR}/${TIMER_NAME}" >/dev/null <<'TIMER'
[Unit]
Description=Weekly cleanup of orphaned and disabled snaps

[Timer]
OnCalendar=weekly
Persistent=true
AccuracySec=1h
Unit=orphand-snaps.service

[Install]
WantedBy=timers.target
TIMER

  echo "Reloading systemd and enabling timer..."
  "$ELEV" systemctl daemon-reload
  "$ELEV" systemctl enable --now "${TIMER_NAME}"

  echo "Installing man page..."
  "$ELEV" install -d -m 0755 "${MAN_DST_DIR}"
  "$ELEV" tee "${MAN_PAGE_RAW}" >/dev/null <<'MANPAGE'
.TH ORPHAND_SNAPS 8 "2025-12-09" "orphand_snaps" "System Administration"
.SH NAME
orphand_snaps \- remove orphaned and disabled snap packages, with undo support
.SH SYNOPSIS
.B orphand_snaps
.RI [ install | uninstall | undo " [" SNAPNAME " | all ]" ]
.SH DESCRIPTION
The orphand_snaps script:
- Removes disabled snaps and orphaned content/base snaps if safe to delete.
- Records removed snaps from the last run in
.I /var/lib/orphand_snaps/last_removed.txt
to support undo.
- Installs a systemd oneshot service and weekly timer.
Elevation via
.B doas
or
.B sudo
is auto-detected; override with
.B OVERRIDE_ELEVATION=doas|sudo
.
.SH COMMANDS
.TP
.B install
Install the script to /usr/local/bin and set up systemd service/timer.
.TP
.B uninstall
Remove systemd units and the installed script; delete state directory.
.TP
.B undo
List snaps removed in the last run.
.TP
.B "undo SNAPNAME"
Restore a single snap (uses snap refresh/install; revision if recorded).
.TP
.B "undo all"
Restore all snaps recorded in the last run.
.SH FILES
.I /usr/local/bin/orphand_snaps
\- installed script
.br
.I /etc/systemd/system/orphand-snaps.service
.br
.I /etc/systemd/system/orphand-snaps.timer
.br
.I /var/lib/orphand_snaps/last_removed.txt
\- state file (name,channel[,revision])
.SH EXAMPLES
Install: OVERRIDE_ELEVATION=doas orphand_snaps install
.br
Undo list: orphand_snaps undo
.br
Undo one: orphand_snaps undo core18
.br
Undo all: orphand_snaps undo all
.SH SEE ALSO
.BR snap (8),
.BR systemctl (1)
.SH AUTHOR
Mario Herrmann <marioherrmann at posteo.de>
MANPAGE

  "$ELEV" gzip -f "${MAN_PAGE_RAW}" || true
  "$ELEV" mandb -q || true

  echo "Installation complete. The timer is active:"
  systemctl list-timers "${TIMER_NAME}" --no-legend || true
}

uninstall_units() {
  local ELEV; ELEV="$(get_elev)"

  echo "Disabling and removing systemd timer and service..."
  "$ELEV" systemctl disable --now "${TIMER_NAME}" || true
  "$ELEV" systemctl disable "${SERVICE_NAME}" 2>/dev/null || true
  "$ELEV" systemctl daemon-reload

  "$ELEV" rm -f "${SYSTEMD_DIR}/${TIMER_NAME}" "${SYSTEMD_DIR}/${SERVICE_NAME}"

  echo "Removing ${INSTALL_PATH}..."
  "$ELEV" rm -f "${INSTALL_PATH}"

  echo "Removing state directory..."
  "$ELEV" rm -rf "${STATE_DIR}"

  echo "Removing man page..."
  "$ELEV" rm -f "${MAN_PAGE_GZ}" "${MAN_PAGE_RAW}" || true
  "$ELEV" mandb -q || true

  echo "Uninstallation complete."
}

# State file format (from now on):
# Line 1: "# timestamp: <ISO8601>"
# Following lines: "<name>[,<channel>][,<revision>]"

# helper: get channel of a snap from 'snap info'
get_snap_channel() {
  local name="$1"
  # tracking column (last column) may be "-" or non-channel; sanitize to stable
  local ch
  ch=$(snap list 2>/dev/null | awk -v n="$name" '$1==n {print $NF}')
  case "${ch}" in
    ""|"-"|"base"|"latest" )
      echo "stable"
      ;;
    *)
      echo "${ch}"
      ;;
  esac
}

# Record removed snaps to the state file (one name per line, de-duplicated)
record_removed() {
  local removed_list=("$@")
  local ELEV; ELEV="$(get_elev)"
  "$ELEV" install -d -m 0755 "${STATE_DIR}"
  {
    echo "# timestamp: $(date -Iseconds)"
    printf "%s\n" "${removed_list[@]}" | awk 'NF' | sort -u
  } | "$ELEV" tee "${STATE_FILE}" >/dev/null
}

# Undo helpers
undo_list() {
  ensure_state
  if ! test -s "${STATE_FILE}"; then
    echo "No undo information available."
    return 0
  fi
  echo "Snaps removed in last run (name,channel[,revision]):"
  awk 'NR>1 {print $0}' "${STATE_FILE}"
}

# helper: reinstall via refresh if installed, else install; support revision
reinstall_snap() {
  local name="$1"
  local channel="${2:-}"
  local revision="${3:-}"
  local is_installed
  is_installed=$(snap list 2>/dev/null | awk -v n="$name" '$1==n {print $1}')
  local ELEV; ELEV="$(get_elev)"

  if [ -n "$revision" ]; then
    if [ -z "$is_installed" ]; then
      "$ELEV" snap install "$name" || return 1
    fi
    "$ELEV" snap refresh "$name" --revision="$revision"
    return $?
  fi

  if [ -n "$is_installed" ]; then
    if [ -n "$channel" ]; then
      "$ELEV" snap refresh "$name" --channel "$channel"
    else
      "$ELEV" snap refresh "$name"
    fi
  else
    if [ -n "$channel" ]; then
      "$ELEV" snap install "$name" --channel "$channel"
    else
      "$ELEV" snap install "$name"
    fi
  fi
}

undo_install_one() {
  ensure_state
  local snapname="${1:-}"
  if [ -z "${snapname}" ]; then
    echo "Usage: ${SCRIPT_NAME} undo snapname"; return 1
  fi
  if ! awk -F, -v s="$snapname" 'NR>1 && $1==s {found=1} END{exit !found}' "${STATE_FILE}" 2>/dev/null; then
    echo "Snap '${snapname}' not found in last removal list."; return 1
  fi
  local channel revision
  channel=$(awk -F, -v s="$snapname" 'NR>1 && $1==s {print $2; exit}' "${STATE_FILE}")
  revision=$(awk -F, -v s="$snapname" 'NR>1 && $1==s {print $3; exit}' "${STATE_FILE}")

  if [ -n "$revision" ]; then
    echo "Restoring '${snapname}' to revision '${revision}'..."
    reinstall_snap "$snapname" "$channel" "$revision"
  else
    if [ -n "$channel" ]; then
      printf "Restoring '%s' on channel '%s'...\n" "$snapname" "$channel"
    else
      printf "Restoring '%s'...\n" "$snapname"
    fi
    reinstall_snap "$snapname" "$channel"
  fi
}

undo_install_all() {
  ensure_state
  if ! test -f "${STATE_FILE}"; then
    echo "No undo information available."; return 0
  fi
  echo "Restoring all snaps from last run..."
  # shellcheck disable=SC2016
  awk -F, 'NR>1 {print $1 "|" $2 "|" $3}' "${STATE_FILE}" | while IFS='|' read -r name channel revision; do
    [ -n "$name" ] || continue
    if [ -n "$revision" ]; then
      echo "Restoring '${name}' to revision '${revision}'..."
      reinstall_snap "$name" "$channel" "$revision" || echo "Failed to restore '${name}'."
    else
      if [ -n "$channel" ]; then
        printf "Restoring '%s' on channel '%s'...\n" "$name" "$channel"
      else
        printf "Restoring '%s'...\n" "$name"
      fi
      reinstall_snap "$name" "$channel" || echo "Failed to restore '${name}'."
    fi
  done
}

# Ensure state directory and initialize header
begin_run_state() {
  ensure_state
  local ELEV; ELEV="$(get_elev)"
  "$ELEV" sh -c "printf '# timestamp: %s\n' \"$(date -Iseconds)\" > '${STATE_FILE}'"
}

# Append one entry: name,channel[,revision]
append_removed() {
  local line="$1"
  local ELEV; ELEV="$(get_elev)"
  if ! grep -Fxq "$line" "${STATE_FILE}" 2>/dev/null; then
    "$ELEV" sh -c "printf '%s\n' \"$line\" >> '${STATE_FILE}'"
  fi
}

run_cleanup() {
  begin_run_state
  # Remove disabled snaps
  while read -r snapname revision; do
    channel=$(get_snap_channel "$snapname")
    local ELEV; ELEV="$(get_elev)"
    if "$ELEV" snap remove "$snapname" --revision="$revision"; then
      append_removed "${snapname},${channel},${revision}"
    else
      echo "Error removing disabled snap ${snapname}@${revision}"
    fi
  done < <(LANG=C snap list --all | awk "/disabled/{print \$1, \$3}")

  # Orphans
  orphan=$(snap connections --all | grep -E 'content' | grep -vE 'themes|slot' | awk '$2 == "-" {print $3}' | cut -d: -f 1)
  provider=$(grep "default-provider:" /snap/*/*/meta/snap.yaml 2>/dev/null | awk '{print $NF}' | sort -u)
  if [ -n "${orphan}" ]; then
    for o in ${orphan}; do
      if [[ " ${provider} " == *" ${o} "* ]]; then
        echo "Snap ${o} is a default provider and cannot be removed."
      else
        channel=$(get_snap_channel "$o")
        local ELEV; ELEV="$(get_elev)"
        if "$ELEV" snap remove "${o}"; then
          append_removed "${o},${channel}"
        else
          echo "Error removing snap ${o}"
        fi
      fi
    done
  else
    echo "No orphaned snaps found."
  fi

  # Bases
  corephan=$(snap list --all | grep -E 'base' | awk '{print $1}' | cut -d: -f 1)
  base=$(grep "base:" /snap/*/*/meta/snap.yaml 2>/dev/null | awk '{print $NF}' | sort -u)
  for b in ${corephan}; do
    bplug=$(grep "base:" /snap/*/*/meta/snap.yaml 2>/dev/null | cut -d '/' -f 3 | awk '{print $NF}' | sort -u)
    if [[ " ${base} " == *" ${b} "* ]]; then
      echo "${b} is a base for ${bplug} and cannot be removed."
    else
      channel=$(get_snap_channel "$b")
      local ELEV; ELEV="$(get_elev)"
      if "$ELEV" snap remove "${b}"; then
        append_removed "${b},${channel}"
      else
        echo "Error removing snap ${b}"
      fi
    fi
  done
}

help() {
  echo "Usage: ${SCRIPT_NAME} [install|uninstall|undo [snapname|all]|help]"
  echo
  echo "Commands:"
  echo
  echo "  install               Install the script, systemd service and timer."
  echo "  uninstall             Remove the installed script and systemd units."
  echo "  undo                  List snaps removed in the last run."
  echo "  undo snapname         Restore a single snap removed in the last run."
  echo "  undo all              Restore all snaps removed in the last run."
  echo "  help                  Show this help message."
  echo
}

case "${1:-}" in
  install)
    install_units
    ;;
  uninstall|remove)
    uninstall_units
    ;;
  undo)
    # undo [snapname|all|<none>]
    case "${2:-}" in
      "" )
        undo_list
        ;;
      all)
        undo_install_all "$@"
        ;;
      *)
        undo_install_one "${2}"
        ;;
    esac
    ;;
  help)
    help
    ;;
  *)
    run_cleanup
    ;;
esac
